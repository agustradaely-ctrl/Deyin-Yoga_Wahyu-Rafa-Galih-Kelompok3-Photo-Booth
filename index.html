 <!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Photo Booth Live Frame dengan Timer & Suara</title>
<style>
/* ===== BODY & LAYOUT PREMIUM ===== */
body {
  font-family: 'Montserrat', sans-serif;
  background: linear-gradient(145deg, #0f2027, #203a43, #2c5364);
  margin: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #f0f0f0;
}

/* HEADER */
h1 {
  font-size: 2.8em;
  margin-bottom: 20px;
  color: #ffffff;
  text-shadow: 0 0 20px #ff4d6d, 0 0 40px #ff4d6d66;
}

/* CAMERA CONTAINER */
#camera-container {
  position: relative;
  display: none;
  border-radius: 30px;
  overflow: hidden;
  box-shadow: 0 20px 50px rgba(0,0,0,0.7);
  background: #111;
  border: 2px solid rgba(255,255,255,0.1);
  width: 100%;
  max-width: 540px; /* tetap seperti ukuran semula di layar besar */
  margin: auto;
}

/* VIDEO & FRAME */
video, canvas, #frame-overlay {
  width: 100%;       /* sebelumnya 540px, sekarang otomatis */
  height: auto;      /* sebelumnya 400px */
  aspect-ratio: 4 / 3; /* menjaga proporsi video */
  border-radius: 30px;
  object-fit: cover;
  box-shadow: inset 0 0 25px rgba(255,255,255,0.08);
  transform: scaleX(-1);
}

/* FRAME OVERLAY (bingkai) */
#frame-overlay {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
  display: none;
  border-radius: 30px;
  box-shadow: 0 0 25px rgba(255,255,255,0.2);
  transform: scaleX(-1);
  z-index: 2;
}

/* --- RESPONSIVE UNTUK HP --- */
@media (max-width: 600px) {
  #camera-container {
    max-width: 95%; /* agar tidak melebihi layar HP */
  }

  video, canvas, #frame-overlay {
    width: 100%;
    height: auto;
    aspect-ratio: 4 / 3;
  }
}

/* COUNTDOWN NEON */
#countdown {
  position: absolute;
  top: 42%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 95px;
  font-weight: 900;
  color: #00ffff;
  text-shadow: 0 0 10px #00ffff, 0 0 25px rgba(0,255,255,0.5);
  display: none;
}

/* VIDEO TIMER */
#videoTimer {
  position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 28px;
  font-weight: 700;
  color: #00ffea;
  background: rgba(0,0,0,0.55);
  padding: 8px 20px;
  border-radius: 20px;
  display: none;
  box-shadow: 0 8px 25px rgba(0,255,255,0.25);
  text-shadow: 0 0 5px #00fff0;
}

/* ===== BUTTONS PREMIUM ICON STYLE ===== */
button, select {
  margin: 8px;
  padding: 14px 24px;
  border-radius: 20px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(12px);
}

button {
  background: linear-gradient(145deg, #ff416c, #ff4b2b);
  color: #fff;
  font-size: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.45);
  position: relative;
}

button::after {
  content: '';
  position: absolute;
  top:0; left:0;
  width: 100%; height: 100%;
  border-radius: 20px;
  box-shadow: 0 0 15px rgba(255,255,255,0.25);
  pointer-events: none;
}

button:hover {
  transform: translateY(-3px) scale(1.03);
  box-shadow: 0 12px 28px rgba(0,0,0,0.55), 0 0 12px rgba(255,255,255,0.3);
}

button:active {
  transform: translateY(1px) scale(0.99);
  box-shadow: 0 6px 18px rgba(0,0,0,0.55);
}

/* SELECT */
select {
  background: rgba(255,255,255,0.12);
  color: #fff;
  font-size: 15px;
  padding: 10px 16px;
  backdrop-filter: blur(8px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

/* ===== GALLERY THUMB ===== */
#gallery {
  margin-top: 30px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 16px;
}

.thumb {
  width: 100px;
  height: 75px;
  object-fit: cover;
  border-radius: 18px;
  cursor: pointer;
  box-shadow: 0 10px 28px rgba(0,0,0,0.45);
  transition: all 0.35s ease;
}

.thumb:hover {
  transform: scale(1.15) rotate(-1.5deg);
  box-shadow: 0 14px 38px rgba(0,0,0,0.6);
}

/* ===== MODAL PREVIEW ===== */
#previewModal {
  display: none;
  position: fixed;
  top: 0; left:0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.95);
  justify-content: center;
  align-items: center;
}

#previewWrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 35px;
}

#previewModal img {
  max-width: 80%;
  max-height: 80%;
  border-radius: 25px;
  box-shadow: 0 0 45px rgba(0,255,255,0.5);
}

/* NAV BUTTONS */
.nav-btn {
  background: rgba(0,255,255,0.2);
  border: none;
  border-radius: 50%;
  font-size: 32px;
  font-weight: bold;
  cursor: pointer;
  padding: 16px 20px;
  transition: all 0.35s ease;
  color: #00ffff;
  text-shadow: 0 0 10px #00ffff;
}

.nav-btn:hover {
  background: rgba(0,255,255,0.5);
  transform: scale(1.2);
}

/* VIDEO CONTROLS */
#videoControls {
  display: none;
  position: absolute;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%);
  gap: 14px;
  z-index: 10;
}

/* ANIMASI SHRINK FADE */
@keyframes floatShrinkHold {
  0% { transform: scale(1) translateY(0); opacity: 1; }
  30% { transform: scale(1) translateY(0); opacity: 1; } /* tahan sebentar */
  100% { transform: scale(0.5) translateY(50px); opacity: 0; }
}

.float-shrink-hold {
  animation: floatShrinkHold 2s forwards; /* durasi total 1.5 detik */
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

/* ===== Perbaikan dropdown select agar opsi terlihat ===== */
select {
  color: #fff; /* teks opsi putih */
  background-color: rgba(0,0,0,0.4); /* background semi transparan */
  border: 1px solid rgba(255,255,255,0.3); /* border agar terlihat */
  appearance: none; /* hilangkan default styling browser */
  -webkit-appearance: none;
  -moz-appearance: none;
}

/* Opsi dalam dropdown */
select option {
  color: #000; /* teks opsi bisa diubah sesuai tema, misal hitam untuk kontras */
  background-color: #fff; /* background opsi putih agar terlihat */
}

/* Pilihan saat hover */
select option:hover {
  background-color: #00ffff33; /* highlight warna neon seperti tema */
  color: #000;
}

/* Tambahkan panah ‚ñº custom untuk select */
select {
  position: relative;
  padding-right: 30px; /* ruang untuk panah */
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Cpolygon points='0,0 12,0 6,6' fill='%23fff'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 12px;
  
}
/* ===== RESPONSIVE UNTUK HP/SCREEN KECIL ===== */
@media (max-width: 768px) {
  #main-container {
    flex-direction: column; /* kolom kiri-tengah-kanan jadi atas-bawah */
    align-items: center;
    gap: 20px;
  }

  #left-panel, #right-panel {
    width: 90%; /* panel kiri & kanan lebih kecil agar muat layar HP */
    display: flex;
    flex-direction: row; /* tombol-tombol tersusun horizontal */
    flex-wrap: wrap; /* jika terlalu banyak, pindah baris */
    justify-content: center;
  }

  #center-panel {
    width: 100%;
  }

  video, canvas, #frame-overlay {
    width: 100%; /* video & frame memenuhi layar HP */
    height: auto;
  }

  #videoControls {
    bottom: 10px; /* geser tombol kontrol video agar muat */
  }

  #videoWrapper {
  transform-origin: center;
  }

  /* Pastikan frame mengikuti ukuran video/canvas */
#frameOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;       /* sesuaikan otomatis */
  height: 100%;      /* sesuaikan otomatis */
  object-fit: cover; /* biar frame menyesuaikan tanpa ketarik */
  pointer-events: none; /* biar nggak ganggu klik di bawahnya */
}

}
</style>
</head>
<body>
<h1>üì∏ Photo Booth</h1>

<!-- MAIN CONTAINER 3 KOLOM -->
<div id="main-container" style="display:flex; gap:30px; justify-content:center; align-items:flex-start;">

  <!-- KOLOM KIRI: tombol utama -->
  <div id="left-panel" style="display:flex; flex-direction:column; gap:3px;">
    <button id="startBtn">Nyalakan Kamera</button>
    <button id="captureBtn">Ambil Foto</button>
    <button id="videoBtn">Video</button>
    <button id="deleteBtn">Hapus Foto/Video</button>
    <button id="downloadBtn">Download Hasil</button>
    <button id="stopBtn">Matikan Kamera</button>
  </div>

  <!-- KOLOM TENGAH: kamera & video -->
  <div id="center-panel" style="position:relative;">
    <div id="camera-container">
      <video id="video" autoplay></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <img id="frame-overlay" src="" alt="Frame Overlay">
      <div id="countdown"></div>
      <div id="videoTimer"></div>
      <div id="videoControls">
        <button id="startRecBtn">‚è∫</button>
        <button id="pauseRecBtn" style="display:none;">‚è∏</button>
        <button id="resumeRecBtn" style="display:none;">‚èØ</button>
        <button id="stopRecBtn" style="display:none;">‚èπ</button>
      </div>
    </div>
  </div>

  <!-- KOLOM KANAN: timer, filter, frame -->
  <div id="right-panel" style="display:flex; flex-direction:column; gap:22px;">
    <label for="timerSelect">Timer:</label>
    <select id="timerSelect">
      <option value="0">Tanpa Timer</option>
      <option value="3">3 Detik</option>
      <option value="5">5 Detik</option>
      <option value="10">10 Detik</option>
    </select>

    <label for="filterSelect">Filter:</label>
    <select id="filterSelect">
      <option value="none">Normal</option>
      <option value="grayscale(1)">Grayscale</option>
      <option value="sepia(1)">Sepia</option>
      <option value="contrast(1.5)">Kontras Tinggi</option>
      <option value="brightness(1.3)">Lebih Cerah</option>
      <option value="blur(2px)">Blur</option>
    </select>

    <label for="frameSelect">Frame:</label>
    <select id="frameSelect">
      <option value="">Tanpa Frame</option>
      <option value="frame1.png">Frame 1</option>
      <option value="frame2.png">Frame 2</option>
      <option value="frame3.png">Frame 3</option>
      <option value="frame4.png">Frame 4</option>
    </select>
  </div>

</div>

<h3>Hasil Foto/Video:</h3>
<div id="gallery"></div>

<div id="previewModal" onclick="this.style.display='none'">
  <div id="previewWrapper" onclick="event.stopPropagation()">
    <button id="prevBtn" class="nav-btn" onclick="showPrev(event)">&lt;</button>
    <img id="previewImage" src="">
    <button id="nextBtn" class="nav-btn" onclick="showNext(event)">&gt;</button>
  </div>
</div>

<script>

const video = document.getElementById('video');  
const canvas = document.getElementById('canvas');  
const frameOverlay = document.getElementById('frame-overlay');  
const countdownEl = document.getElementById('countdown');  
const startBtn = document.getElementById('startBtn');  
const stopBtn = document.getElementById('stopBtn');  
const captureBtn = document.getElementById('captureBtn');  
const downloadBtn = document.getElementById('downloadBtn');  
const deleteBtn = document.getElementById('deleteBtn');  
const timerSelect = document.getElementById('timerSelect');  
const filterSelect = document.getElementById('filterSelect');  
const gallery = document.getElementById('gallery');  
const videoBtn = document.getElementById('videoBtn');  
const videoControlsContainer = document.getElementById('videoControls');  
const startRecBtn = document.getElementById('startRecBtn');  
const stopRecBtn = document.getElementById('stopRecBtn');  
const pauseRecBtn = document.getElementById('pauseRecBtn');  
const prevBtn = document.getElementById('prevBtn');  
const nextBtn = document.getElementById('nextBtn');  
// ===== Video timer & preview =====  
const videoTimerEl = document.getElementById('videoTimer');  
let videoTimerInterval = null;  
let videoStartTime = null;  
const frameSelect = document.getElementById('frameSelect');

frameSelect.addEventListener('change', () => {
  const selectedFrame = frameSelect.value;
  if (!selectedFrame) {
    frameOverlay.style.display = 'none';
    currentFrame = "";
  } else {
    currentFrame = selectedFrame;
    frameOverlay.src = selectedFrame;
    frameOverlay.style.display = 'block';
  }
});  
// Mulai timer video  
// Mulai timer video
function startVideoTimer() {  
  videoTimerEl.style.display = 'block';  
  videoStartTime = Date.now();  
  videoTimerInterval = setInterval(updateVideoTimer, 500);  
}

// Hentikan timer video
function stopVideoTimer() {  
  clearInterval(videoTimerInterval);  
  videoTimerEl.style.display = 'none';  
}

// Jeda timer video
function pauseVideoTimer() {  
  if (videoTimerInterval) clearInterval(videoTimerInterval);  
  if (videoStartTime) {
    videoPausedTime = Date.now() - videoStartTime; // simpan durasi saat pause
  }
}

// Lanjutkan timer video setelah pause
function resumeVideoTimer() {  
  if (videoPausedTime == null) return;  
  videoStartTime = Date.now() - videoPausedTime; // hitung offset
  videoTimerInterval = setInterval(updateVideoTimer, 500);
}

// Fungsi pembaruan tampilan timer
function updateVideoTimer() {
  const diff = Math.floor((Date.now() - videoStartTime) / 1000);  
  const h = Math.floor(diff / 3600).toString().padStart(2,'0');  
  const m = Math.floor((diff % 3600 / 60)).toString().padStart(2,'0');  
  const s = (diff % 60).toString().padStart(2,'0');  
  videoTimerEl.textContent = `${h}:${m}:${s}`;
}
  
let stream = null;  
let currentFrame = "";  
let audioEnabled = false;  
let galleryImages = [];  
let currentIndex = 0;  
let showingPhoto = false;  
let isPreviewActive = false; 
let mediaRecorder = null;  
let recordedChunks = [];  
  
function addToGallery(item) {
  const index = galleryImages.length;
  galleryImages.push({ data: item, type: 'photo', frame: currentFrame }); // simpan frame saat foto diambil

  const thumb = document.createElement('img');
  thumb.className = "thumb";
  thumb.src = item;

  // ketika diklik, tampilkan langsung di canvas di atas video
  thumb.onclick = () => {
    currentIndex = index;
    showingPhoto = true;
    showOnCamera(index); // tampilkan dengan frame yang tersimpan
  };

  gallery.appendChild(thumb);
}
 
// Fungsi khusus untuk video  
function addVideoToGallery(videoURL) {
  const index = galleryImages.length;
  galleryImages.push({ data: videoURL, type: 'video', frame: currentFrame }); // simpan frame saat video

  const vid = document.createElement('video');
  vid.src = videoURL;
  vid.className = "thumb";
  vid.muted = true;
  vid.loop = true;
  vid.autoplay = true;

  vid.onclick = () => {
    currentIndex = index;
    showVideoOnCamera(videoURL, true, galleryImages[index].frame); // kirim frame yang tersimpan
  };

  gallery.appendChild(vid);
}
// üîä Bunyi timer  
function playBeep() {  
  if (!audioEnabled) return;  
  const ctx = new AudioContext();  
  const osc = ctx.createOscillator();  
  osc.type = "square";  
  osc.frequency.value = 800;  
  const gain = ctx.createGain();  
  gain.gain.value = 0.1;  
  osc.connect(gain);  
  gain.connect(ctx.destination);  
  osc.start();  
  osc.stop(ctx.currentTime + 0.1);  
}  
  
// üîä Suara jepret  
function playShutter() {  
  if (!audioEnabled) return;  
  const shutterSound = new Audio("camera-13695.mp3");
  shutterSound.play().catch(err => console.warn("Gagal memutar suara jepret:", err));  
}  
  
// üé• Nyalakan kamera  
async function startCamera() {  
  try {  
    document.getElementById('camera-container').style.display = 'inline-block';  
    stream = await navigator.mediaDevices.getUserMedia({ video: { width: 480, height: 360 }, audio: false });
    video.srcObject = stream;  
    video.style.display = 'block';  
    canvas.style.display = 'none';  
    if (currentFrame !== "") frameOverlay.style.display = 'block';  
    audioEnabled = true;  
    showingPhoto = false;  
  
    // Sembunyikan kontrol video jika sebelumnya muncul  
    videoControlsContainer.style.display = 'none';  
  } catch (err) {  
    alert("Tidak dapat mengakses kamera: " + err);  
  }  
}  
  
// ‚èπ Matikan kamera dengan sempurna  
function stopCamera() {  
  if (stream) {  
    stream.getTracks().forEach(track => track.stop());  
    stream = null;  
  }  
  
  // Matikan tampilan kamera  
  video.srcObject = null;  
  video.src = "";  
  video.pause();  
  video.style.display = 'none';  
  
  // Sembunyikan semua elemen kamera  
  canvas.style.display = 'none';  
  frameOverlay.style.display = 'none';  
  videoControlsContainer.style.display = 'none';  
  videoTimerEl.style.display = 'none';  
  stopVideoTimer();  
  
  // Tampilkan kembali galeri hasil  
  gallery.style.display = 'flex';  
  
  // Sembunyikan tombol kontrol video  
  startRecBtn.style.display = 'none';  
  pauseRecBtn.style.display = 'none';  
  stopRecBtn.style.display = 'none';  
  if (typeof resumeRecBtn !== 'undefined')  
    resumeRecBtn.style.display = 'none';  
  
  console.log("üî¥ Kamera dimatikan sepenuhnya.");  
}  
  
// üì∏ Ambil foto  
function capturePhoto() {  
  const ctx = canvas.getContext('2d');  
  canvas.width = video.videoWidth;  
  canvas.height = video.videoHeight;  

  ctx.save();

  // Terapkan filter sebelum menggambar video agar hasil foto ikut filter
  ctx.filter = filterSelect.value || "none";  

  // Balik kamera (mirror)
  ctx.scale(-1, 1);  
  ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);  

  ctx.restore();  

  // Suara jepretan
  playShutter();  

  const finalizeCapture = (imageData) => {
    addToGallery(imageData);

    canvas.style.display = 'block';

    // Tampilkan frame jika ada yang dipilih, jangan sembunyikan
    if (currentFrame !== "") {
      frameOverlay.style.display = 'block';
    } else {
      frameOverlay.style.display = 'none';
    }

    // tambahkan animasi float-shrink-hold
    canvas.classList.add('float-shrink-hold');

    canvas.addEventListener('animationend', function handler() {
      canvas.classList.remove('float-shrink-hold');
      // reset canvas tanpa menyembunyikan video
      canvas.width = 0;
      canvas.height = 0;
      canvas.style.display = 'none';
      canvas.removeEventListener('animationend', handler);
    });
  };

  if (currentFrame !== "") {  
    const frame = new Image();  
    frame.src = currentFrame;  
    frame.onload = function() {  
      // Gambar frame di atas hasil kamera yang sudah difilter
      ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);  
      finalizeCapture(canvas.toDataURL("image/png"));  
    };  
  } else {  
    finalizeCapture(canvas.toDataURL("image/png"));  
  }  
}
// üíæ Download foto/video  
function downloadPhoto() {  
  if (galleryImages.length === 0) {  
    alert("Belum ada foto atau video untuk diunduh!");  
    return;  
  }  
  
  const item = galleryImages[currentIndex];  
  if (!item) {  
    alert("Silakan pilih foto atau video terlebih dahulu!");  
    return;  
  }  
  
  const link = document.createElement('a');  
  
  // üü¢ Jika format lama (foto disimpan langsung sebagai string base64)  
  if (typeof item === 'string') {  
    link.href = item;  
    link.download = `photo_${currentIndex + 1}.png`;  
  }  
  // üîµ Jika format baru berupa objek dengan type 'photo' atau 'video'  
  else if (item.type === 'photo') {  
    link.href = item.data;  
    link.download = `photo_${currentIndex + 1}.png`;  
  } else if (item.type === 'video') {  
    link.href = item.data;  
    link.download = `video_${currentIndex + 1}.webm`;  
  } else {  
    alert("Tipe file tidak dikenali!");  
    return;  
  }  
  
  link.click();  
}  
  
// üñº Tampilkan hasil foto/video di layar kamera  
function showOnCamera(index) {
  currentIndex = index;
  showingPhoto = true;

  // sembunyikan video saat menampilkan foto
  if (stream) video.style.display = 'none';

  const item = galleryImages[index];
  const ctx = canvas.getContext('2d');
  const img = new Image();
  img.src = item.data;

  img.onload = function() {
    canvas.width = video.videoWidth || 480;
    canvas.height = video.videoHeight || 360;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Flip horizontal agar efek cermin sama seperti saat pengambilan foto
    ctx.save();
    ctx.scale(-1, 1);
    ctx.drawImage(img, -canvas.width, 0, canvas.width, canvas.height);
    ctx.restore();

    // tampilkan frame yang tersimpan di foto tersebut
    if (item.frame) {
      const frameImg = new Image();
      frameImg.src = item.frame;
      frameImg.onload = () => {
        ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
      };
    }

    canvas.style.display = 'block';
    frameOverlay.style.display = 'none'; // jangan tampilkan frame global
  };

 // updateNavigationButtons();
}
  
function showVideoOnCamera(url, isPreview = false) {  
  video.pause();  
  video.srcObject = null;      
  video.src = url;  
  video.controls = true;  
  video.autoplay = true;  
  video.muted = false;  
  video.loop = false;  
  video.style.display = 'block';  
  canvas.style.display = 'none';  
  frameOverlay.style.display = 'none';  

  // ‚úÖ Gunakan pembungkus agar hanya tampilan video yang mirror, bukan kontrolnya
  let videoWrapper = document.getElementById('videoWrapper');
  if (!videoWrapper) {
    // Buat pembungkus secara otomatis kalau belum ada
    videoWrapper = document.createElement('div');
    videoWrapper.id = 'videoWrapper';
    video.parentNode.insertBefore(videoWrapper, video);
    videoWrapper.appendChild(video);
    videoWrapper.style.position = "relative";
    videoWrapper.style.display = "inline-block";
    videoWrapper.style.transformOrigin = "center";
  }

  // Reset transformasi agar aman
  video.style.transform = "scaleX(1)";
  videoWrapper.style.transform = "none";

  if (isPreview) {
    // ‚úÖ Video hasil rekaman: tampil NORMAL (tidak mirror) tapi kontrol tetap benar
    videoWrapper.style.transform = "scaleX(-1)";
  } else {
    // üé• Live camera atau saat rekam video: tetap mirroring
    videoWrapper.style.transform = "scaleX(-1)";
  }

  if (isPreview) {  
    videoControlsContainer.style.display = 'none';  
    stopVideoTimer();  
  } else {  
    videoControlsContainer.style.display = 'flex';  
    startVideoTimer();  
  }  
}

function showNext(event) {  
  event.stopPropagation();  
  if (currentIndex < galleryImages.length - 1) {  
    currentIndex++;  
    showOnCamera(currentIndex);  
  }  
}  
  
// üîπ Tombol kontrol video di dalam kamera  
videoBtn.onclick = async () => {  
  if (!stream) {  
    showCameraAlert("üé• Nyalakan kamera terlebih dahulu!");  
    return;  
  }  
  
  // 1Ô∏è‚É£ Pastikan kamera aktif kembali  
  await startCamera();  
  
canvas.style.display = 'none';
// frameOverlay.style.display = 'none';
video.controls = false;
showingPhoto = false;

// Jangan sembunyikan frame jika ada yang dipilih
if(currentFrame !== "") {
  frameOverlay.style.display = 'block';
} else {
  frameOverlay.style.display = 'none';
}
  // 3Ô∏è‚É£ Tampilkan kontrol untuk perekaman video baru  
  videoControlsContainer.style.display = 'flex';  
  startRecBtn.style.display = 'inline-block';  
  stopRecBtn.style.display = 'none';  
  pauseRecBtn.style.display = 'none';  
  
  // 4Ô∏è‚É£ Sembunyikan timer video sampai mulai rekam  
  stopVideoTimer();  
};  
  
startRecBtn.onclick = async () => {
  if (!stream) return;

  recordedChunks = [];

  // Ambil audio dari mikrofon
  let audioStream = null;
  try {
    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch (err) {
    console.warn("Tidak dapat mengakses mikrofon: ", err);
  }

  const recordingCanvas = document.createElement('canvas');
  recordingCanvas.width = video.videoWidth;
  recordingCanvas.height = video.videoHeight;
  const rctx = recordingCanvas.getContext('2d');

  // üîπ Tambahan baru: ambil filter yang sedang dipilih
  const filterValue = filterSelect.value || "none";

  // üîπ Variabel untuk tracking frame yang sedang dipakai
  let frameImage = null;
  let lastFrameSrc = "";

  const drawFrame = () => {
    if (!stream) return;
    rctx.clearRect(0, 0, recordingCanvas.width, recordingCanvas.height);

    // Terapkan filter ke setiap frame video
    rctx.filter = filterValue;

    // Gambar video
    rctx.drawImage(video, 0, 0, recordingCanvas.width, recordingCanvas.height);

    // üîπ Update frame overlay jika dipakai
    if (currentFrame && currentFrame !== lastFrameSrc) {
      frameImage = new Image();
      frameImage.src = currentFrame;
      lastFrameSrc = currentFrame;
      frameImage.onload = () => {
        rctx.drawImage(frameImage, 0, 0, recordingCanvas.width, recordingCanvas.height);
      };
    } else if (frameImage) {
      // Gambar frameImage yang sudah ada
      rctx.drawImage(frameImage, 0, 0, recordingCanvas.width, recordingCanvas.height);
    }

    requestAnimationFrame(drawFrame);
  };
  drawFrame();

  // üîπ Ambil video dari canvas (sudah termasuk filter)
  const canvasStream = recordingCanvas.captureStream(30);
  const combinedStream = audioStream
    ? new MediaStream([...canvasStream.getVideoTracks(), ...audioStream.getAudioTracks()])
    : canvasStream;

  // üîπ Rekam hasil stream berfilter
  mediaRecorder = new MediaRecorder(combinedStream);
  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) recordedChunks.push(e.data);
  };

  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: "video/webm" });
    const url = URL.createObjectURL(blob);
    addVideoToGallery(url);
    stopVideoTimer();
  };

  mediaRecorder.start();

  startRecBtn.style.display = 'none';
  pauseRecBtn.style.display = 'inline-block';
  stopRecBtn.style.display = 'inline-block';
  startVideoTimer();
};

pauseRecBtn.onclick = () => {  
  if (!mediaRecorder) return;  
  if (mediaRecorder.state === 'recording') {  
    mediaRecorder.pause();  
    pauseVideoTimer(); // hentikan timer saat pause  
    pauseRecBtn.style.display = 'none';  
    resumeRecBtn.style.display = 'inline-block'; // munculkan tombol resume  
  }  
};  
  
resumeRecBtn.onclick = () => {  
  if (!mediaRecorder) return;  
  if (mediaRecorder.state === 'paused') {  
    mediaRecorder.resume();  
    resumeRecBtn.style.display = 'none';  
    pauseRecBtn.style.display = 'inline-block'; // tampilkan pause lagi  
    resumeVideoTimer(); // lanjutkan timer saat resume
  }  
};
stopRecBtn.onclick = () => {  
  if (!mediaRecorder) return;  
  mediaRecorder.stop();  
  mediaRecorder.onstop = () => {  
    const blob = new Blob(recordedChunks, { type: "video/webm" });  
    const url = URL.createObjectURL(blob);  
    addVideoToGallery(url);  
    stopVideoTimer(); // hentikan timer saat stop  
  };  
  
  // Setelah stop, tampilkan hanya tombol start lagi  
  startRecBtn.style.display = 'inline-block';  
  stopRecBtn.style.display = 'none';  
  pauseRecBtn.style.display = 'none';  
  if (typeof resumeRecBtn !== 'undefined')  
    resumeRecBtn.style.display = 'none';  
  videoControlsContainer.style.display = 'none';  
};  
// üé¨ Tombol kontrol utama  
startBtn.onclick = startCamera;  
stopBtn.onclick = stopCamera;  

captureBtn.onclick = () => {
  if (!stream) {
    showCameraAlert(); // tampilkan pop-up jika kamera belum aktif
    return;
  }

  // Jika sedang menampilkan hasil foto di layar kamera
  if (showingPhoto) {
    // üëâ Tekan pertama: kembali ke mode kamera, tidak mengambil foto
    showingPhoto = false;
    isPreviewActive = false;
    startCamera(); // aktifkan kembali mode kamera
    return;
  }

  // üëâ Tekan kedua atau normal: ambil foto seperti biasa
  handleCapture();
};
downloadBtn.onclick = downloadPhoto;  
  
deleteBtn.onclick = () => {  
  if (galleryImages.length === 0) { 
    alert("Belum ada foto/video yang bisa dihapus!"); 
    return; 
  }  

  const deletedItem = galleryImages.splice(currentIndex, 1)[0]; // hapus item

  // Hapus thumbnail dari galeri
  if (gallery.children[currentIndex]) gallery.removeChild(gallery.children[currentIndex]);  

  // Tentukan index berikutnya yang akan ditampilkan
  if (currentIndex >= galleryImages.length) currentIndex = galleryImages.length - 1;  

  if (currentIndex >= 0) {
    const nextItem = galleryImages[currentIndex];
    if (nextItem.type === 'photo') {
      showOnCamera(currentIndex);
    } else if (nextItem.type === 'video') {
      showVideoOnCamera(nextItem.data, true);
    }
  } else {
    // Tidak ada item tersisa, kembalikan ke mode kamera
    startCamera();
  }
};
  
filterSelect.addEventListener("change", () => {  
  video.style.filter = filterSelect.value;  
});  
  
function handleCapture() {  
  if (!stream) {  
    alert("‚ö† Nyalakan kamera terlebih dahulu!");  
    return;  
  }  
  
  const seconds = parseInt(timerSelect.value);  
  if (seconds === 0) { capturePhoto(); return; }  
  
  countdownEl.style.display = 'block';  
  let count = seconds;  
  countdownEl.textContent = count;  
  
  const interval = setInterval(() => {  
    playBeep();  
    count--;  
    countdownEl.textContent = count;  
    if (count <= 0) {  
      clearInterval(interval);  
      countdownEl.style.display = 'none';  
      capturePhoto();  
    }  
  }, 1000);  
}  
  
// Update tombol navigasi kiri-kanan  
function updateNavigationButtons() {  
  if (currentIndex <= 0) prevBtn.style.display = 'none'; else prevBtn.style.display = 'inline-block';  
  if (currentIndex >= galleryImages.length - 1) nextBtn.style.display = 'none'; else nextBtn.style.display = 'inline-block';  
}  
  
const cameraAlert = document.getElementById('cameraAlert');  
const closeAlertBtn = document.getElementById('closeAlertBtn');  
  
function showCameraAlert() {  
  cameraAlert.style.display = 'flex';  
}  
  
closeAlertBtn.onclick = () => {  
  cameraAlert.style.display = 'none';  
};  
  
cameraAlert.onclick = (e) => {  
  if (e.target === cameraAlert) cameraAlert.style.display = 'none';  
};  
</script>  
</body>  
</html>   